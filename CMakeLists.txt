# ============================================================================
# CMakeLists.txt for arch3-rosetta
# ============================================================================
# Generated by rosetta-create
#
# Usage:
#   mkdir build && cd build
#   cmake ..
#   make
#   ./arch3_rosetta_generator project.json
# ============================================================================

cmake_minimum_required(VERSION 3.16)
project(arch3_rosetta_binding_generator VERSION 1.0.0 LANGUAGES CXX)

set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_POSITION_INDEPENDENT_CODE ON)

# ============================================================================
# FetchContent for dependencies
# ============================================================================
include(FetchContent)

# ----------------------------------------------------------------------------
# Rosetta Library
# ----------------------------------------------------------------------------
message(STATUS "Fetching Rosetta library...")
FetchContent_Declare(
    rosetta
    GIT_REPOSITORY https://github.com/xaliphostes/rosetta.git
    GIT_TAG        main
    GIT_SHALLOW    TRUE
)

# Disable Rosetta unit tests
set(ROSETTA_BUILD_TESTING OFF)

FetchContent_MakeAvailable(rosetta)
FetchContent_GetProperties(rosetta SOURCE_DIR ROSETTA_SOURCE_DIR)
set(ROSETTA_INCLUDE_DIR "${ROSETTA_SOURCE_DIR}/include")

# ----------------------------------------------------------------------------
# arch3 Library (fetched from GitHub)
# ----------------------------------------------------------------------------
message(STATUS "Fetching arch3 library...")
FetchContent_Declare(
    arch3
    GIT_REPOSITORY https://github.com/xaliphostes/arch3.git
    GIT_TAG        main
    GIT_SHALLOW    FALSE
)

# Disable tests for fetched library
set(BUILD_TESTING OFF CACHE BOOL "" FORCE)

FetchContent_MakeAvailable(arch3)
FetchContent_GetProperties(arch3 SOURCE_DIR ARCH3_SOURCE_DIR)
set(ARCH3_INCLUDE_DIR "${ARCH3_SOURCE_DIR}/include")
set(ARCH3_SRC_DIR     "${ARCH3_SOURCE_DIR}/src")
set(ARCH3_LIB_DIR     "/Users/fmaerten/devs/c++/bin")

# ----------------------------------------------------------------------------
# nlohmann_json (for configuration parsing)
# ----------------------------------------------------------------------------
find_package(nlohmann_json 3.9 QUIET)
if(NOT nlohmann_json_FOUND)
    message(STATUS "Fetching nlohmann_json...")
    FetchContent_Declare(
        nlohmann_json
        GIT_REPOSITORY https://github.com/nlohmann/json.git
        GIT_TAG        v3.11.3
        GIT_SHALLOW    TRUE
    )
    FetchContent_MakeAvailable(nlohmann_json)
endif()

# ============================================================================
# Generator executable
# ============================================================================
add_executable(arch3_rosetta_generator
    main.cxx
)

# Place the executable in a convenient location
set_target_properties(arch3_rosetta_generator PROPERTIES
    RUNTIME_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/.."
)

# Include directories
target_include_directories(arch3_rosetta_generator PRIVATE
    # Rosetta
    ${ROSETTA_INCLUDE_DIR}

    # arch3 library headers
    ${ARCH3_INCLUDE_DIR}
    ./extern/eigen
    ./extern/krylov/include
    ${ARCH3_SRC_DIR}

    # Local bindings directory
    ${CMAKE_CURRENT_SOURCE_DIR}
    ${CMAKE_CURRENT_SOURCE_DIR}/bindings
)

# ============================================================================
# Find the Arch3 library
# ============================================================================
find_library(ARCH3_LIBRARY
    NAMES Arch3 libArch3
    PATHS ${ARCH3_LIB_DIR}
    NO_DEFAULT_PATH
)

if(NOT ARCH3_LIBRARY)
    message(FATAL_ERROR "Arch3 library not found in ${ARCH3_LIB_DIR}")
endif()
message(STATUS "Found Arch3: ${ARCH3_LIBRARY}")

# Link libraries
target_link_libraries(arch3_rosetta_generator PRIVATE
    nlohmann_json::nlohmann_json
    ${ARCH3_LIBRARY}
)

# ============================================================================
# Print configuration summary
# ============================================================================
message(STATUS "")
message(STATUS "============================================================")
message(STATUS "arch3-rosetta Binding Generator Configuration")
message(STATUS "============================================================")
message(STATUS "  arch3 source:      ${ARCH3_SOURCE_DIR}")
message(STATUS "  Rosetta include:      ${ROSETTA_INCLUDE_DIR}")
message(STATUS "============================================================")
message(STATUS "")
message(STATUS "  1. Build: cmake --build .")
message(STATUS "  2. Run: ./arch3_rosetta_generator project.json")
